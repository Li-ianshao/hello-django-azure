{% load custom_filters %}
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Stock Table</title>
  <style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 30px;
        background-color: #f5f7fa;
    }

    button {
        padding: 10px 30px;
        background-color: #007acc;
        color: white;
        border: none;
        border-radius: 5px;
    }

    /* æ¢ä»¶å¼æ¨£å¼ */
    .rsi-high {
        background-color: #ffd6d6 !important;  /* æ·¡ç´…è‰² */
        color: #a80000;
        font-weight: bold;
    }

    .rsi-low {
        background-color: #d6ecff !important;  /* æ·¡è—è‰² */
        color: #004f9e;
        font-weight: bold;
    }

    .no-dividend {
        background-color: #eeeeee !important;
        color: #999;
    }

    .high-volume {
        background-color: #e2f7e2 !important;  /* æ·¡ç¶ è‰² */
        font-weight: bold;
    }

    /* åŸºæœ¬æ¨£å¼ */

    h2 {
        text-align: center;
        color: #333;
        margin-bottom: 20px;
    }

    /* å¤–å±¤å®¹å™¨æ§åˆ¶å¯æ©«å‘æ»‘å‹• */
    .table-container {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    margin: 0 auto;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        background-color: white;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
        min-width: 1000px; /* é™åˆ¶æœ€å°å¯¬åº¦ä»¥é¿å…å£“ç¸® */
    }

    /* RWD å°è¢å¹•ï¼šå¯¬åº¦å°æ–¼ 768px */
    @media (max-width: 768px) {
    table {
        font-size: 12px;
        min-width: 800px; /* å†å£“ç¸®ä¸€é» */
    }

    th, td {
        padding: 6px 8px;
    }

    .table-container {
        padding: 0 10px;
    }
    }

    /* æ›´å°è¢å¹•ï¼ˆæ‰‹æ©Ÿï¼‰ */
    @media (max-width: 480px) {
    table {
        min-width: 600px;
        font-size: 11px;
    }
    }

    th, td {
        border: 1px solid #ddd;
        padding: 12px 16px;
        text-align: center;
    }

    th {
        background-color: #007acc;
        color: white;
        font-weight: bold;
    }

    tr:nth-child(even) {
        background-color: #f2f2f2;
    }

    tr:hover {
        background-color: #e8f4fd;
    }

  </style>
</head>
<body>
  <form action="{% url 'logout' %}" method="post">
      {% csrf_token %}
      <button type="submit">ç™»å‡º</button>
  </form>

  <h2 style="text-align: center;">ğŸ“ˆ Stock Overview</h2>

  <div class="table-container">
    <table>
        <thead>
        <tr>
            <th data-index="0" onclick="sortTable(this)">
                <span class="header-label">ä»£ç¢¼</span>
                <span class="sort-arrow"></span>
            </th>
            <th data-index="1" onclick="sortTable(this)">
                <span class="header-label">æ”¶ç›¤åƒ¹</span>
                <span class="sort-arrow"></span>
            </th>
            <th data-index="2" onclick="sortTable(this)">
                <span class="header-label">é…æ¯æ—¥</span>
                <span class="sort-arrow"></span>
            </th>
            <th data-index="3" onclick="sortTable(this)">
                <span class="header-label">é…æ¯</span>
                <span class="sort-arrow"></span>
            </th>
            <th data-index="4" onclick="sortTable(this)">
                <span class="header-label">æ­¤æ¬¡é…æ¯ç‡</span>
                <span class="sort-arrow"></span>
            </th>
            <th data-index="5" onclick="sortTable(this)">
                <span class="header-label">æ®–åˆ©ç‡</span>
                <span class="sort-arrow"></span>
            </th>
            <th data-index="6" onclick="sortTable(this)">
                <span class="header-label">ç•¶æ—¥æ¼²è·Œå¹…</span>
                <span class="sort-arrow"></span>
            </th>
            <th data-index="7" onclick="sortTable(this)">
                <span class="header-label">ä¸€å¹´æœ€ä½åƒ¹</span>
                <span class="sort-arrow"></span>
            </th>
            <th data-index="8" onclick="sortTable(this)">
                <span class="header-label">ä¸€å¹´æœ€é«˜åƒ¹</span>
                <span class="sort-arrow"></span>
            </th>
            <th data-index="9" onclick="sortTable(this)">
                <span class="header-label">RSI</span>
                <span class="sort-arrow"></span>
            </th>
            <th data-index="10" onclick="sortTable(this)">
                <span class="header-label">volume_Delta</span>
                <span class="sort-arrow"></span>
            </th>
        </tr>
        </thead>
        <tbody>
        {% for s in stocks %}
        <tr>
            <td>{{ s.symbol }}</td>
            

            <td>{{ s.close|dollar_or_na }}</td>

            <td title="{% if s.dividend_date == 'N/A' %}ç„¡å¯ç”¨é…æ¯æ—¥è³‡æ–™{% else %}é…æ¯æ—¥ (ex-dividend date){% endif %}">
                {{ s.ex_dividend_date }}
            </td>

            <td title="{% if not s.dividend or s.dividend == 0 or s.dividend == 'N/A' %}æ­¤è‚¡ç¥¨ä¸é…æ¯{% else %}é…æ¯ä¸­{% endif %}"
                class="{% if not s.dividend or s.dividend == 0 %}no-dividend{% endif %}">
                {{ s.dividend|dollar_or_na }}
            </td>

            <td title="{% if not s.dividend_ratio or s.dividend_ratio == 0 or s.dividend_ratio == 'N/A' %}æ­¤è‚¡ç¥¨ä¸é…æ¯{% else %}é…æ¯ä¸­{% endif %}"
                class="{% if not s.dividend_ratio or s.dividend_ratio == 0 %}no-dividend{% endif %}">
                {{ s.dividend_ratio|percent_or_na }}
            </td>

            <td title="{% if not s.yield or s.yield == 0 or s.yield == 'N/A' %}æ­¤è‚¡ç¥¨ä¸é…æ¯{% else %}é…æ¯ä¸­{% endif %}"
                class="{% if not s.yield or s.yield == 0 %}no-dividend{% endif %}">
                {{ s.yield|percent_or_na }}
            </td>

            <td title="{% if s.price_change > 10 %}è®Šå‹•ç¦å¤§{% else %}æ­£å¸¸æ³¢å‹•{% endif %}"
                class="{% if s.price_change|default:0 > 10 %}high-volume{% endif %}">
                {{ s.price_change|percent_or_na }}
            </td>

            <td>
                {{ s.year_low }}
            </td>

            <td>
                {{ s.year_high }}
            </td>

            <td title="{% if s.rsi != 'N/A' %}
                        {% if s.rsi > 70 %}
                            RSI éç†± (>70)
                        {% elif s.rsi < 30 %}
                            RSI è¶…è·Œ (<30)
                        {% else %}
                            RSI æ­£å¸¸ç¯„åœ
                        {% endif %}
                        {% else %}
                            ç„¡ RSI è³‡æ–™
                        {% endif %}"
                class="
                    {% if s.rsi != 'N/A' %}
                        {% if s.rsi > 70 %}
                            rsi-high
                        {% elif s.rsi < 30 %}
                            rsi-low
                        {% endif %}
                    {% endif %}
                ">
                {{ s.rsi }}
            </td>

            <td title="{% if s.volume_delta > 100 %}é«˜æˆäº¤é‡{% else %}æ­£å¸¸æˆäº¤é‡{% endif %}"
                class="{% if s.volume_delta|default:0 > 100 %}high-volume{% endif %}">
                {{ s.volume_delta|percent_or_na }}
            </td>
            
        </tr>
        {% endfor %}
        </tbody>
    </table>
  </div>
</body>
<script>
    let currentSortedIndex = null;
    let currentAscending = true;

    function sortTable(th) {
    const n = parseInt(th.dataset.index);
    const table = document.querySelector("table");
    const rows = Array.from(table.rows).slice(1);
    const isNumeric = !isNaN(parseFloat(rows[1].cells[n].innerText.replace('%', '').replace('$', '')));

    // åˆ‡æ›æ’åºæ–¹å‘
    let asc = true;
    if (currentSortedIndex === n) {
        asc = !currentAscending;
    }
    currentSortedIndex = n;
    currentAscending = asc;

    rows.sort((a, b) => {
        let x = a.cells[n].innerText.replace('%', '').replace('$', '');
        let y = b.cells[n].innerText.replace('%', '').replace('$', '');

        if (x === 'N/A') return 1;
        if (y === 'N/A') return -1;

        if (isNumeric) {
        x = parseFloat(x);
        y = parseFloat(y);
        }

        return asc ? (x > y ? 1 : -1) : (x < y ? 1 : -1);
    });

    for (let row of rows) {
        table.tBodies[0].appendChild(row);
    }

    // âœ… æ¸…é™¤æ‰€æœ‰ç®­é ­
    document.querySelectorAll(".sort-arrow").forEach(span => {
        span.textContent = "";
    });

    // âœ… åŠ ä¸Šç•¶å‰ç®­é ­
    th.querySelector(".sort-arrow").textContent = asc ? " â†‘" : " â†“";
    }
</script>
</html>
